{% extends "base.html" %}

{% block title %}Reportes - LogiCo{% endblock %}

{% block content %}
<div class="page-title d-flex justify-content-between align-items-center mb-3">
  <h1><i class="bi bi-newspaper"></i> Reportes</h1>
</div>

<!-- Filtros -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-3">
        <label class="form-label fw-semibold">Tipo de Reporte</label>
        <select name="tipo_filtro" class="form-select" id="id_tipo_filtro">
          <option value="diario" {% if tipo_filtro == 'diario' %}selected{% endif %}>Diario</option>
          <option value="mensual" {% if tipo_filtro == 'mensual' %}selected{% endif %}>Mensual</option>
          <option value="anual" {% if tipo_filtro == 'anual' %}selected{% endif %}>Anual</option>
          <option value="general" {% if tipo_filtro == 'general' %}selected{% endif %}>General</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Fecha</label>
        <input type="date" name="fecha" value="{{ fecha }}" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Mes</label>
        <input type="month" name="mes" value="{{ mes }}" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">Año</label>
        <input type="number" name="anio" value="{{ anio }}" class="form-control" min="2000" max="2100">
      </div>

      <div class="col-md-2">
        <label class="form-label fw-semibold">ID único</label>
        <input type="text" name="id_motorista" class="form-control" value="{{ id_motorista }}">
      </div>

      <div class="col-12 text-end mt-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search"></i> Filtrar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Botones Exportación -->
<div class="d-flex justify-content-end gap-2 mb-3">

  <form method="get" action="{% url 'reporte_csv' %}">
    <input type="hidden" name="tipo_filtro" value="{{ tipo_filtro }}">
    <input type="hidden" name="fecha" value="{{ fecha }}">
    <input type="hidden" name="mes" value="{{ mes }}">
    <input type="hidden" name="anio" value="{{ anio }}">
    <input type="hidden" name="id_motorista" value="{{ id_motorista }}">

    <button type="submit" class="btn btn-success">
      <i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV
    </button>
  </form>

  <form method="get" action="{% url 'reporte_pdf' %}">
    <input type="hidden" name="tipo_filtro" value="{{ tipo_filtro }}">
    <input type="hidden" name="fecha" value="{{ fecha }}">
    <input type="hidden" name="mes" value="{{ mes }}">
    <input type="hidden" name="anio" value="{{ anio }}">
    <input type="hidden" name="id_motorista" value="{{ id_motorista }}">

    <button type="submit" class="btn btn-danger">
      <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
    </button>
  </form>

</div>

<!-- Tabla -->
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead class="table-primary">
        <tr>
          <th>ID Pedido</th>
          <th>Tipo Movimiento</th>
          <th>Farmacia</th>
          <th>Motorista</th>
          <th>Estado</th>
          <th>Fecha Creación</th>
          <th>Tiempo Entrega (min)</th>
        </tr>
      </thead>
      <tbody>
        {% for despacho in despachos %}
          <tr>
            <td>{{ despacho.identificador_unico }}</td>
            <td>{{ despacho.get_tipo_movimiento_display }}</td>
            <td>{{ despacho.farmacia_origen.nombre }}</td>
            <td>{{ despacho.motorista_asignado.usuario.get_full_name }}</td>
            <td>{{ despacho.get_estado_display }}</td>
            <td>{{ despacho.fecha_hora_creacion|date:"Y-m-d H:i" }}</td>
            <td>{{ despacho.tiempo_entrega_minutos }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              No hay despachos registrados.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
