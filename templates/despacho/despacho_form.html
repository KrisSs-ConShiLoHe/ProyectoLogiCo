{% extends 'base.html' %} 

{% block title %}{{ titulo }} - LogiCo{% endblock %}

{% block content %}
<h1 class="page-title">
    {{ titulo }}
</h1>

<div class="card p-4">
  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    
    {# -------- VISTA PREVIA DE IMAGEN -------- #}
    <div class="mb-3">
      <img 
        id="preview-imagen"
        src="{% if despacho.imagen %}{{ despacho.imagen.url }}{% endif %}"
        alt="Foto de Despacho"
        class="img-thumbnail"
        style="max-width: 300px; display: {% if despacho.imagen %}block{% else %}none{% endif %};"
      />
    </div>


    {% for field in form %}
      <div class="mb-3">
        <label class="form-label">{{ field.label }}</label>
        {{ field }}
        {% if field.help_text %}
          <div class="form-text">{{ field.help_text }}</div>
        {% endif %}
        {% if field.errors %}
          <div class="invalid-feedback d-block">{{ field.errors }}</div>
        {% endif %}
      </div>
    {% endfor %}


    {% if producto_form %}
    <br><br>
    <div id="producto-container"> 
        <h3>Información del Producto</h3>
        <div class="mb-3">
            {% for field in producto_form %}
                <div class="mb-3">
                    <label class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% if field.errors %}
                        <div class="invalid-feedback d-block">{{ field.errors }}</div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check-circle"></i> Guardar
      </button>
      <a href="{% url 'despacho_listar' %}" class="btn btn-secondary">
        <i class="bi bi-x-circle"></i> Cancelar
      </a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // ---------------------------------------------------------------------
  //  PREVISUALIZAR IMAGEN
  // ---------------------------------------------------------------------
  const inputImagen = document.getElementById("id_imagen");
  const previewImg = document.getElementById("preview-imagen");

  if (inputImagen && previewImg) {
    inputImagen.addEventListener("change", function(event) {
      const file = event.target.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          previewImg.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // ---------------------------------------------------------------------
  //  CARGA DINÁMICA DE MOTORISTAS
  // ---------------------------------------------------------------------
  const farmaciaSelect = document.getElementById('id_farmacia_origen');
  const motoristaSelect = document.getElementById('id_motorista_asignado');
  
  if (farmaciaSelect && motoristaSelect) {
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    farmaciaSelect.addEventListener('change', function() {
      const farmaciaId = this.value;
      
      motoristaSelect.innerHTML = '<option value="">Cargando...</option>';
      motoristaSelect.disabled = true;
      
      if (!farmaciaId) {
        motoristaSelect.innerHTML = '<option value="">Primero seleccione una farmacia</option>';
        motoristaSelect.disabled = false;
        return;
      }
      
      const url = new URL('{% url "motoristas_por_farmacia" %}', window.location.origin);
      url.searchParams.append('farmacia_id', farmaciaId);
      
      fetch(url.toString(), {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        credentials: 'same-origin'
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || `HTTP ${response.status}`);
          });
        }
        return response.json();
      })
      .then(data => {
        motoristaSelect.innerHTML = '<option value="">---------</option>';
        
        if (data.motoristas && data.motoristas.length > 0) {
          data.motoristas.forEach(motorista => {
            const option = document.createElement('option');
            option.value = motorista.id;
            option.textContent = motorista.text;
            motoristaSelect.appendChild(option);
          });
        } else {
          motoristaSelect.innerHTML = '<option value="">No hay motoristas asignados a esta farmacia</option>';
        }
        
        motoristaSelect.disabled = false;
      })
      .catch(error => {
        motoristaSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
        motoristaSelect.disabled = false;
      });
    });

    if (farmaciaSelect.value) {
      farmaciaSelect.dispatchEvent(new Event('change'));
    }
  }

  // ---------------------------------------------------------------------
  //  VISIBILIDAD DE CAMPOS SEGÚN TIPO Y ESTADO
  // ---------------------------------------------------------------------
  const tipoSelect = document.getElementById('id_tipo_movimiento');
  const estadoSelect = document.getElementById('id_estado');
  
  if (!tipoSelect || !estadoSelect) return;

  const productoContainer = document.getElementById('producto-container');
  const conRecetaFields = document.querySelectorAll('.extra-con-receta');
  const trasladoFields = document.querySelectorAll('.extra-con-traslado');
  const reenvioFields = document.querySelectorAll('.extra-reenvio');
  const incidenciaFields = document.querySelectorAll('.extra-incidencia');

  function hideFields(fields) {
    fields.forEach(f => {
      const c = f.closest('.mb-3');
      if (c) c.style.display = 'none';
      else f.style.display = 'none';
    });
  }

  function showFields(fields) {
    fields.forEach(f => {
      const c = f.closest('.mb-3');
      if (c) c.style.display = '';
      else f.style.display = '';
    });
  }

  function onTipoChange() {
    const val = tipoSelect.value;
    
    if (productoContainer) productoContainer.style.display = 'none';
    hideFields(conRecetaFields);
    hideFields(trasladoFields);
    hideFields(reenvioFields);

    if (val === 'DIRECTO') {
      if (productoContainer) productoContainer.style.display = 'block';
    } else if (val === 'CON_RECETA') {
      showFields(conRecetaFields);
    } else if (val === 'CON_TRASLADO') {
      showFields(trasladoFields);
    } else if (val === 'REENVIO') {
      showFields(reenvioFields);
    }
  }

  function onEstadoChange() {
    const val = estadoSelect.value;
    hideFields(incidenciaFields);

    if (val === 'INCIDENCIA') {
      showFields(incidenciaFields);
    }
  }

  tipoSelect.addEventListener('change', onTipoChange);
  estadoSelect.addEventListener('change', onEstadoChange);

  onTipoChange();
  onEstadoChange();
});
</script>

{% endblock %}
